{# tickets.twig #}
{% extends "layout/base.twig" %}

{% block content %}

{% include 'components/dashboard/header.twig' %}

<main class="p-8 px-12 pt-24 max-w-[1440px] mx-auto">
	<h1 class="text-3xl font-bold mb-4" id="pageTitle">
		All Tickets
	</h1>

	<!-- Filter tabs -->
	<div class="flex gap-4 mb-6">
		<a href="tickets" id="allTicketsTab" class="px-4 py-2 rounded-lg transition-colors bg-primary hover:bg-hover text-white">
			All Tickets
		</a>
		<a href="tickets/active" id="activeTicketsTab" class="px-4 py-2 rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300">
			Active Tickets
		</a>
	</div>

	<div class="space-y-3" id="ticketsContainer">
		<!-- Tickets will be rendered here by JavaScript -->
	</div>

	<!-- Delete Dialog -->
	<div id="deleteDialog" class="fixed inset-0 bg-black/20 flex items-center justify-center p-4 z-50 hidden">
		<div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-6 animate-[scale-in_0.2s_ease-out]">
			<h2 class="text-xl font-bold text-gray-900 mb-2">
				Delete Ticket?
			</h2>
			<p class="text-gray-600 mb-6" id="deleteDialogMessage">
				Are you sure you want to delete this ticket? This action cannot be undone.
			</p>
			<div class="flex gap-3 justify-end">
				<button id="cancelDeleteBtn" class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
					Cancel
				</button>
				<button id="confirmDeleteBtn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
					Delete
				</button>
			</div>
		</div>
	</div>
</main>

<script>
(function() {
	// ============================================
	// ROUTE DETECTION
	// ============================================

	const getCurrentRoute = () => {
		return window.location.pathname;
	};

	const isActiveTicketsRoute = () => {
		return getCurrentRoute() === '/tickets/active';
	};

	// ============================================
	// FILTER & RENDER FUNCTIONS
	// ============================================

	const getDisplayedTickets = (tickets) => {
		if (isActiveTicketsRoute()) {
			return tickets.filter(
				(ticket) => ticket.status === 'open' || ticket.status === 'in_progress'
			);
		}
		return tickets;
	};

	const updateActiveTab = () => {
		const allTicketsTab = document.getElementById('allTicketsTab');
		const activeTicketsTab = document.getElementById('activeTicketsTab');

		if (isActiveTicketsRoute()) {
			allTicketsTab.className = 'px-4 py-2 rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300';
			activeTicketsTab.className = 'px-4 py-2 rounded-lg transition-colors bg-primary text-white';
		} else {
			allTicketsTab.className = 'px-4 py-2 rounded-lg transition-colors bg-primary text-white';
			activeTicketsTab.className = 'px-4 py-2 rounded-lg transition-colors bg-gray-200 text-gray-700 hover:bg-gray-300';
		}
	};

	const renderTickets = () => {
		const tickets = loadTickets();
		const displayedTickets = getDisplayedTickets(tickets);
		const container = document.getElementById('ticketsContainer');
		const pageTitle = document.getElementById('pageTitle');

		// Update page title
		pageTitle.textContent = isActiveTicketsRoute() ? 'Active Tickets' : 'All Tickets';

		// Update active tab styling
		updateActiveTab();

		// Show empty state if no tickets
		if (displayedTickets.length === 0) {
			container.innerHTML = `
				<p class="text-center text-muted-foreground py-8">
					${isActiveTicketsRoute() ? 'No active tickets.' : 'No tickets yet.'}
					<a class="hover:underline" href="/dashboard">
						Create your first ticket here
					</a>
				</p>
			`;
			return;
		}

		// Render tickets using shared utility function
		container.innerHTML = displayedTickets
			.map(ticket => renderTicketCard(ticket, true))
			.join('');
	};

	// ============================================
	// INITIALIZATION
	// ============================================

	document.addEventListener('DOMContentLoaded', () => {
		// Initialize delete dialog with refresh callback
		const deleteDialog = createDeleteDialog();
		deleteDialog.initialize(renderTickets);

		// Render tickets
		renderTickets();
	});
})();
</script>

{% endblock %}
